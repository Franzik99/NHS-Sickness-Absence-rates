import pandas as pd
import numpy as np

nhsdata = pd.read_excel("/Users/francisisaac/downloads/NHS/NHSSicknessAbsencerates.xlsx",sheet_name="Table 1",skiprows=2)
nhsdata.head(10)

nhsdata = nhsdata.dropna(subset=["Month"])
nhsdata.head(9)

nhsdata["Month"] = pd.to_datetime(nhsdata["Month"], format="%B %Y")
nhsdata.head(10)

rate_cols = nhsdata.columns[1:]

nhsdata[rate_cols] = nhsdata[rate_cols].apply(pd.to_numeric, errors="coerce")
nhsdata.head(10)

import matplotlib.pyplot as plt
plt.figure()
plt.plot(nhsdata["Month"], nhsdata["England"])
plt.title("England NHS Sickness Absence Rate Over Time")
plt.xlabel("Year")
plt.ylabel("Sickness Absence Rate (%)")
plt.show()

from statsmodels.tsa.seasonal import seasonal_decompose
ts = nhsdata.set_index("Month")["England"]

decomposition = seasonal_decompose(ts, model="additive", period=12)
decomposition.plot()
plt.show()

from statsmodels.tsa.statespace.sarimax import SARIMAX
from sklearn.metrics import mean_absolute_error

train = ts.iloc[:-12]
test = ts.iloc[-12:]

model = SARIMAX(
    train,
    order=(1, 1, 1),
    seasonal_order=(1, 1, 1, 12),
    enforce_stationarity=False,
    enforce_invertibility=False
)

results = model.fit()
print(results.summary())

forecast = results.get_forecast(steps=12)
forecast_mean = forecast.predicted_mean
forecast_ci = forecast.conf_int()

plt.figure(figsize=(10, 5))

plt.plot(train.index, train, label="Training data")
plt.plot(test.index, test, label="Actual data", color="black")
plt.plot(forecast_mean.index, forecast_mean, label="Forecast", color="red")

plt.fill_between(
    forecast_ci.index,
    forecast_ci.iloc[:, 0],
    forecast_ci.iloc[:, 1],
    color="pink",
    alpha=0.3,
    label="95% CI"
)

plt.title("SARIMA Forecast â€“ England NHS Sickness Absence")
plt.xlabel("Month")
plt.ylabel("Sickness Absence Rate")
plt.legend()
plt.show()

mae = mean_absolute_error(test, forecast_mean)
print(f"MAE: {mae:.3f}")

final_model = SARIMAX(
    ts,
    order=(1, 1, 1),
    seasonal_order=(1, 1, 1, 12),
    enforce_stationarity=False,
    enforce_invertibility=False
)

final_results = final_model.fit()

future_forecast = final_results.get_forecast(steps=12)
future_mean = future_forecast.predicted_mean
future_ci = future_forecast.conf_int()










